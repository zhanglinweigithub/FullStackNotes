---
title: RDB
---
# 目录

[[toc]]

## RDB持久化

RDB全称Redis Database Backup file（Redis数据备份文件），也被叫做`Redis`数据快照。

简单来说就是把内存中的所有数据都记录到磁盘中。

当`Redis`实例故障重启后，从磁盘读取快照文件，恢复数据。

快照文件称为`RDB`文件，默认是保存在当前运行目录。

### 执行时机

RDB持久化在四种情况下会执行：

- 执行`save`命令
- 执行`bgsave`命令
- `Redis`停机时
- 触发`RDB`条件时



**1）save命令**

执行下面的命令，可以立即执行一次RDB：

![image-20210725144536958](./img/image-20210725144536958.png)

`save`命令会导致主进程执行`RDB`，这个过程中其它所有命令都会被阻塞。只有在数据迁移时可能用到。



**2）bgsave命令**

下面的命令可以异步执行RDB：

![image-20210725144725943](./img/image-20210725144725943.png)

这个命令执行后会开启独立进程完成`RDB`，主进程可以持续处理用户请求，不受影响。



**3）停机时**

`Redis`停机时会执行一次`save`命令，实现`RDB`持久化。



**4）触发RDB条件**

`Redis`内部有触发`RDB`的机制，可以在`redis.conf`文件中找到，格式如下：

```properties
# 900秒内，如果至少有1个key被修改，则执行bgsave ， 如果是save "" 则表示禁用RDB
save 900 1  
save 300 10  
save 60 10000 
```



`RDB`的其它配置也可以在`redis.conf`文件中设置：

```properties
# 是否压缩 ,建议不开启，压缩也会消耗cpu，磁盘的话不值钱
rdbcompression yes

# RDB文件名称
dbfilename dump.rdb  

# 文件保存的路径目录
dir ./ 
```



### RDB原理

`bgsave`开始时会`fork`主进程得到子进程，子进程共享主进程的内存数据。完成`fork`后读取内存数据并写入 `RDB` 文件。

`fork`采用的是`copy-on-write`技术：

- 当主进程执行读操作时，访问共享内存；
- 当主进程执行写操作时，则会拷贝一份数据，执行写操作。

![image-20210725151319695](./img/image-20210725151319695.png)





### 小结

`RDB`方式`bgsave`的基本流程？

- `fork`主进程得到一个子进程，共享内存空间
- 子进程读取内存数据并写入新的`RDB`文件
- 用新`RDB`文件替换旧的`RDB`文件

`RDB`会在什么时候执行？`save 60 1000`代表什么含义？

- 默认是服务停止时
- 代表60秒内至少执行1000次修改则触发`RDB`

`RDB`的缺点？

- `RDB`执行间隔时间长，两次`RDB`之间写入数据有丢失的风险
- `fork`子进程、压缩、写出`RDB`文件都比较耗时



